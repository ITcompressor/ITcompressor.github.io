<h4>Запросы</h4>
Поиск not null значений
<pre>db.mycollection.find({"IMAGE URL":{$exists:true}});</pre>
Поиск регуляркой, альтернатива like:
<pre>db.mycollection.find({name: /regular/});</pre>
Поиск 'in'
<pre>db.mycollection.find({ field: { $in: ["one","two","123"]}});</pre>
Сортировка desc
<pre>db.getCollection('my_collection').find({}).sort({"_id": -1})</pre>
Поиск 'not in' with sort desc
<pre>db.getCollection('my_collection').find({"any_field": {$nin: ["any_value"]}}).sort({"_id": -1})</pre>
Массовый апдейт
<pre>
db.mycollection.updateMany({
    field5: { $in : ["fieldany","ANY_VALUE"]},
    $or:[
        {"fields.field5" : null},
        {"fields.field3" : null},
        {"fields.field4" : null}, {
            $and:[{
                "fields.field1" : false
            },{
                "fields.field2" : null
            }]
        }
]}, { 
    $set: {
        "currentStep" : "ANY_FIELD" ,
        "finished" : false
    }
});
</pre>
Массовый апдейт c find, используя фишки js
<pre>
db.mycollection.find({
    "fields.snils":/-/
}).forEach(function(e,i) {
    e.fields.snils = e.fields.snils.replace(/-/g, '');
    db.mycollection.save(e);
});
</pre>
Разовые апдейты
<pre>
db.mycollection.update({ 
    _id: id
}, {
    $set: { 
        "finished": false 
    },
    $currentDate: { 
        "lastModified": true 
    }
})
</pre>

<pre>
db.mycollection.findAndModify({
    query: {"uuid":"8fd8052e-5377-40ce-a941-76865f178c82"},
    sort: {"_id": -1 },
    update: {$set: {"field2": false}}
})
</pre>

<hr>

<h4>Профайлинг</h4>
1) Включаем профайлинг медленных запросов
<pre>db.setProfilingLevel(1, { slowms: 2000 })</pre>
2) Через 1 минуту выключаем
<pre>db.setProfilingLevel(0)</pre>
3) Cмотрим последний профайл
<pre>db.system.profile.find().limit(10).sort( { ts : -1 } ).pretty()</pre>

<h4>Создание индекса</h4>
1) Устанавливаем index !!!!ванжо!!!!! c background mode иначе залочит все
<pre>db.getCollection('rawUserStat').createIndex( { "extra.name": 1 }, { background: true } )</pre>
2) Просмотр статуса создания индекса (Просмотр активностей)
<pre>db.currentOp()</pre>

<hr>

<h4>Примеры агрегации</h4>
db.getCollection('my_collection').aggregate([{
    $match: { $and: [
        { entityType: 'ANY_FIELD' }, 
        { unloadDate: ISODate("2018-01-04 21:00:00.000Z") }
    ]}
}, {
    $group: {
        _id: {
            "entityType": "$entityType",
            "part": "$part",
            "unloadDate": "$unloadDate"
        },
        aggregate: {
            $push: {
                ids: "$ids",
                value: "$info"
            }
        },
        counts: {
            $sum: 1
        }
    }
}]);

<hr>

